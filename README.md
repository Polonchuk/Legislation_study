# Скрипты проекта "Legislation study" собирают и обрабатывают данные с федерального портала проектов нормативных правовых актов [regulation.gov.ru](https://regulation.gov.ru)

Скрипты позволяют собрать разнообразные данные о проектах, выбранных по заданным пользователем параметрам, скачать с сайта текстовые версии проектов документов и сопроводительных документов, перевести тексты документов в формат json и загрузить в базу данных ElasticSearch для дальнейшего анализа текстов документов инструментами ElasticSearch.

Параметры выбора проектов аналогичны фильтрам, которые доступны в "расширенном поиске" самого сайта. Это, например, временной период размещения проекта, тип документа (к примеру, проекты постановлений правительства или проекты федеральных законов), организация-инициатор проекта (к примеру, МинПромТорг или Центральный Банк РФ).


## Порядок работы скриптов:
В данный момент реализовано два скрипта, выполняющих последовательно сбор, обработку и загрузку данных в ElasticSearch:

1. *interact_html.py* предназначен для сбора данных с сайта. На вход он должен получить параметры, по которым будут определены интересующие пользователя проекты. 
На выходе скрипт предоставляет серию файлов нескольких типов. Все они поступят на вход второму скрипту для загрузки в ElasticSearch:
* **файл со списком проектов** - Название файла формируется как строка из переменной *DOCS_LIST_FILE_NAME_PATTERN* в *config.ini*, даты текущего запроса в формате *ГГГГММДД* и расширения *.json*. Один такой файл создается при каждом запуске скрипта. Файл сохраняется в рабочую директорию, где лежат скрипты. 
* **файл с данными о конкретном проекте** - Название файла формируется как шестизначный ID проекта (указан первым элементом для каждого проекта в файле со списком проектов), затем слово *metadata*, дата запроса и расширение *.json* (например, *110579_metadata_20210626.json*). Один такой файл создается на каждый проект, попавший в **файл со списком проектов**. Файл содержит данные со страницы, которая открывается браузером (отрисовывается скриптами сайта) при обращении к конкретному проекту. В частности, в этот файл собираются "коды" файлов с версиями текстов, необходимые при формировании запросов на скачивание файлов с текстами с сайта. Этот и все последующие файлы сохраняются в подпапку рабочей папки. Ее название регулируется переменной *DOCS_SUBDIRECTORY_NAME* в *config.ini*.
* **текстовый файл с сайта** - Файл с названием вида *110579_stage_2_version_1_20210626.docx* - файл, скачанный со страницы проекта. Может содержать как версию текста проекта документа на различных стадиях разработки, так и другую сопроводительную информацию (например, заключение об оцене регулирующего воздействия). Может иметь различные расширения: docx, doc, rtf, pdf. В случае pdf-файлов это сканы-картинки документов. Такие файлы в дальнейшем игнорируются программой.
* **текст из текстового файла с сайта** - Файл с названием вида *110579_stage_2_version_1_20210626.json*. Представляет собой текст из скачанного с сайта текстового файла в формате json. Этот файл будет использован как источник текста при загрузке в ElasticSearch.

2. *elastic_upload.py* предназначен для сбора данных по проекту из нескольких файлов в единую структуру и загрузки этой информации в ElasticSearch. Функция *upload_docs_list* должна получить на вход название **файла со списком проектов**. Результатом работы скрипта будут данные по проектам, собранные из "файла со списком проектов", "файлов с данными о проекте" и "файлов с текстами документов" и сохраненные в ElasticSearch.


## Установка и условия работы скриптов:
* Скрипты писались и отлаживались под Windows, хотя пути прописаны так, что предполагают корректную работу с разными ОС. 
* Использован Python 3.9.2. В связи с использованием f-строк точно не заработает с Python старше версии 3.6.
* Необходимые библиотеки для работы скриптов указаны в requirements.txt.
```
pip install -r requirements.txt
```

Также для работы скриптов дополнительно необходимы:
1. Для работы *interact_html.py* необходим драйвер FireFox (geckodriver). Мной использована версия geckodriver-v0.29.1-win64 с [GitHub](https://github.com/mozilla/geckodriver/releases). Драйвер необходимо скачать, распаковать и положить в системную папку.
2. Для работы *elastic_upload.py* необходимо установить ElasticSearch. Скрипт написан с учетом локальной установки базы. 
Для установки я использовал [Windows MSI Installer](https://www.elastic.co/guide/en/elasticsearch/reference/current/windows.html). Там же дана подробная инструкция по установке. Устанавливал не как сервис, чтобы база запускалась только тогда, когда это необходимо. Соединение с базой прописано в скрипте следующим образом: 
{'host': 'localhost', 'port': 9200}


## Работа со скриптами:
Предполагается последовательное использование скриптов: сначала *interact_html.py*, затем *elastic_upload.py*.

1. Перед запуском *interact_html.py* необходимо определиться, какие именно документы вам нужны. В функции *docs_list_params_setup*, расположенной в файле *interact_html.py* сверху сразу после импортов, вы увидете параметры запроса, выставленные по умолчанию. Например:
```
    params = {
        'sort': 'Date-desc',
        'page': page,
        'pageSize': page_size,
        'group': '',
        'filter': '',
        'npaFilter.IsNotEmpty': 'true',
        'npaFilter.StrSearch': '',
        'npaFilter.SearchType': '0',
        'npaFilter.StartDate': '2020-12-21',
        'npaFilter.EndDate': '2020-12-31',
        # 'npaFilter.StartDateDiscussion': '2020-12-21',
        # 'npaFilter.EndDateDiscussion': '2020-12-31',
        # 'npaFilter.SysFilters[0].ID': '4',
        # 'npaFilter.SysFilters[0].Title': 'Наиболее посещаемые',
        # 'npaFilter.Departments[0].ID': '9',
        # 'npaFilter.Departments[0].Title': 'Минпромторг России',
        # 'npaFilter.Okveds[0].ID': '6',
        # 'npaFilter.Okveds[0].Title': 'Производство пищевых продуктов, включая напитки, и табака',
        # 'npaFilter.Categories[0].ID': '1'
        # 'npaFilter.Categories[0].Title': 'Раскрытие информации о подготовке проектов нормативных правовых актов'
        # 'npaFilter.Categories[0].Code': '01'
        # 'npaFilter.Kinds[0].ID': '1',
        # 'npaFilter.Kinds[0].Title': 'Проект постановления Правительства Российской Федерации',
        # 'npaFilter.Stages[0].Title': 'Текст',
        # 'npaFilter.Stages[0].ID': '30',
        # 'npaFilter.Statuses[0].Title': 'Идет обсуждение',
        # 'npaFilter.Statuses[0].ID': '30',

        'npaFilter.ID': '0',
        'npaFilter.Hidden': 'false',
        'npaFilter.SortOrder': '-1',
        'npaFilter.RowVersion': ''
        }
```
Эти те же параметры поиска, которые вы можете вручную выбрать на странице сайта *regulation.gov.ru* в разделе "Расширенный поиск проектов". Задокументированные строки добавлены в качестве примеров фильтрации. Если запустить поиск с параметрами, указанными выше, задокументированные фильтры работать не будут и скрипт будет запрашивать данные о всех нормативных актах, размещенных всеми ведомствами в течение двух последних недель 2020 года (около 300 из примерно 80 000 проектов документов размещенных на сайте с момента запуска портала).
Фильтрацию стоит иметь ввиду также и потому, что, с целью сбора всей необходимой информации о проектах, скрипт запускает браузер и ждет срабатывания java-скриптов на стороне сайта. Это и установленные в скрипте паузы (timesleep), прежде всего параметр *TEXT_FILES_DOWNLOADING_TIMESLEEP* в *config.ini* (пауза между запросами на скачивание текстовых файлов). Делают работу скрипта медленной. У меня в среднем **100 проектов обрабатываются примерно за 30 минут**. Так что к выбору и объему данных стоит подходить внимательно и выставлять приоритеты. Возможные варианты параметров доступные для выбора будут указаны ниже в разделе **"Варианты параметров запросов"**.
После того, как вы закончили редактирование параметров запроса, сохраните скрипт со вновь установленными параметрами и запустите его в командной строке. Скрипт создаст подпапку для рабочих файлов в выбранной вами рабочей папке и будет складывать туда файлы с данными с сайта. 
При запуске скрипта, если по установленным параметрам сайт отдал более 20 проектов документов, скрипт выдаст количество проектов, удовлетворяющих запросу, и спросит, следует ли ему продолжить работу с таким количеством данных. Если у вас есть возможность дать скрипту поработать *(количество проектов/200)* часов, введите "y" (латиницей) в командной строке, и скрипт приступит к работе.

2. Перед запуском *elastic_upload.py* необходимо включить ElasticSearch. Для этого необходимо запустить командную строку от имени администратора, перейти в папку, где установлен ElasticSearch (по умолчанию это "C:\Program Files\Elastic\Elasticsearch\<*версия продукта*>\bin") и запустить файл (набрать в строке) "elasticsearch".

После того, как ElasticSearch запущен необходимо передать скрипту название **файла со списком проектов**, полученного в результате запуска скрипта *interact_html.py*. Для этого в последнем разделе скрипта *elastic_upload.py*, где перечислены запускаемые функции, в функцию *upload_docs_list* необходимо передать имя этого файла в качестве аргумента, например так:
```
docs_list = upload_docs_list('reg_pub_test_20210615.json')
```
После этого следует сохранить и запустить скрипт в командной строке.

Проверку наличия и вида данных в ElasticSearch можно осуществить, введя в браузере запрос с ID какого-либо из указанных в **файле со списком проектов** проектов, например так:

http://localhost:9200/docs_db_1/_doc/_search?q=115547

где "docs_db_1" значение переменной *ES_INDEX_NAME* из *config.ini*, обозначающей имя таблицы ("индекса" в терминологии ES), а "115547" - ID проекта из файла со списком проектов.

В ответ, на странице браузера будут отображены все собранные данные по этому проекту, включая версии текстов документа.
Разумеется, это только пробный запрос. ElasticSearch умеет гораздо больше! :)


## Варианты параметров запросов
Прежде чем запускать *interact_html.py*, необходимо определиться, какие именно документы скрипт должен собрать. Для этого в функции *docs_list_params_setup* скрипта следует задать дополнительные фильтры, выбирающие нужные вам проекты нормативных актов. Помимо уже указанного в примере выше фильтра по датам размещения документов, интересными для фильтрации могут быть следующие пункты:

* *Departments* - гос. орган, разместивший проект документа. В качестве примера в разделе **"Работа со скриптами"** приведено Министерство промышленности и торговли, но можно подставить МВД или Центральный Банк РФ. Для этого нужно вставить параметры нужного гос. органа после двоеточия и раздокументировать строку. Ниже приведены варианты данных для подстановки. Подставлять следует и ID и название организации (в соответствующие строки фильтра).
```
{"ID":104,"Title":"Генеральная прокуратура Российской Федерации"},
{"ID":37,"Title":"Госкорпорация \u0022Росатом\u0022"},
{"ID":94,"Title":"Госкорпорация \u0022Роскосмос\u0022"},
{"ID":62,"Title":"ГУСП"},
{"ID":59,"Title":"ГФС России"},
{"ID":128,"Title":"Единый государственный заказчик в сфере строительства"},
{"ID":87,"Title":"Казначейство России"},
{"ID":101,"Title":"Коллегия Военно-промышленной комиссии Российской Федерации"},
{"ID":7,"Title":"МВД России"},
{"ID":5,"Title":"МИД России"},
{"ID":75,"Title":"Минвостокразвития России"},
{"ID":11,"Title":"Минздрав России"},
{"ID":118,"Title":"Министерство науки и высшего образования Российской Федерации (Минобрнауки России)"},
{"ID":105,"Title":"Министерство Российской Федерации по делам Крыма"},
{"ID":122,"Title":"Министерство цифрового развития, связи и массовых коммуникаций России"},
{"ID":10,"Title":"Минкавказ России"},
{"ID":31,"Title":"Минкомсвязь России"},
{"ID":8,"Title":"Минкультуры России"},
{"ID":46,"Title":"Минобороны России"},
{"ID":13,"Title":"Минобрнауки России"},
{"ID":14,"Title":"Минприроды России"},
{"ID":9,"Title":"Минпромторг России"},
{"ID":119,"Title":"Минпросвещения России"},
{"ID":34,"Title":"Минрегион России"},
{"ID":2,"Title":"Минсельхоз России"},
{"ID":22,"Title":"Минспорт России"},
{"ID":20,"Title":"Минстрой России"},
{"ID":21,"Title":"Минтранс России"},
{"ID":4,"Title":"Минтруд России"},
{"ID":3,"Title":"Минфин России"},
{"ID":6,"Title":"Минэкономразвития России"},
{"ID":12,"Title":"Минэнерго России"},
{"ID":30,"Title":"Минюст России"},
{"ID":33,"Title":"МЧС России"},
{"ID":102,"Title":"Пенсионный фонд Российской Федерации"},
{"ID":81,"Title":"Росавиация"},
{"ID":43,"Title":"Росавтодор"},
{"ID":88,"Title":"Росаккредитация"},
{"ID":36,"Title":"Росалкогольрегулирование"},
{"ID":66,"Title":"Росархив"},
{"ID":72,"Title":"Росводресурсы"},
{"ID":116,"Title":"Росгвардия"},
{"ID":70,"Title":"Росгидромет"},
{"ID":95,"Title":"Росграница"},
{"ID":82,"Title":"Росжелдор"},
{"ID":64,"Title":"Росздравнадзор"},
{"ID":91,"Title":"Росимущество"},
{"ID":47,"Title":"Роскомнадзор"},
{"ID":49,"Title":"Рослесхоз"},
{"ID":69,"Title":"Росмолодежь"},
{"ID":83,"Title":"Росморречфлот"},
{"ID":73,"Title":"Роснедра"},
{"ID":54,"Title":"Рособоронпоставка"},
{"ID":68,"Title":"Рособрнадзор"},
{"ID":89,"Title":"Роспатент"},
{"ID":76,"Title":"Роспечать"},
{"ID":35,"Title":"Роспотребнадзор"},
{"ID":71,"Title":"Росприроднадзор"},
{"ID":44,"Title":"Росреестр"},
{"ID":90,"Title":"Росрезерв"},
{"ID":79,"Title":"Росрыболовство"},
{"ID":77,"Title":"Россвязь"},
{"ID":78,"Title":"Россельхознадзор"},
{"ID":52,"Title":"Россотрудничество"},
{"ID":74,"Title":"Росстандарт"},
{"ID":92,"Title":"Росстат"},
{"ID":32,"Title":"Ростехнадзор"},
{"ID":80,"Title":"Ространснадзор"},
{"ID":84,"Title":"Роструд"},
{"ID":67,"Title":"Ростуризм"},
{"ID":50,"Title":"Росфинмониторинг"},
{"ID":86,"Title":"Росфиннадзор"},
{"ID":60,"Title":"СВР России"},
{"ID":98,"Title":"Следственный комитет Российской Федерации"},
{"ID":55,"Title":"Спецстрой России"},
{"ID":117,"Title":"Судебный департамент"},
{"ID":63,"Title":"Управление делами Президента Российской Федерации"},
{"ID":103,"Title":"ФАНО России "},
{"ID":41,"Title":"ФАС России"},
{"ID":126,"Title":"Федеральная пробирная палата"},
{"ID":93,"Title":"Федеральная служба по оборонному заказу"},
{"ID":115,"Title":"Федеральное агентство по делам национальностей"},
{"ID":65,"Title":"ФМБА России"},
{"ID":39,"Title":"ФМС России"},
{"ID":85,"Title":"ФНС России"},
{"ID":40,"Title":"ФСБ России"},
{"ID":53,"Title":"ФСВТС России"},
{"ID":57,"Title":"ФСИН России"},
{"ID":42,"Title":"ФСКН России"},
{"ID":96,"Title":"ФСО России"},
{"ID":99,"Title":"ФСС России"},
{"ID":58,"Title":"ФССП России"},
{"ID":45,"Title":"ФСТ России"},
{"ID":48,"Title":"ФСТЭК России"},
{"ID":38,"Title":"ФТС России"},
{"ID":100,"Title":"ФФОМС"},
{"ID":97,"Title":"Центральный банк Российской Федерации"}]
```

* *Kinds* - тип документа. Принцип работы с этим фильтром тот же, что и с фильтром *Departments*.
```
{"ID":2,"Title":"Проект ведомственного акта"},
{"ID":24,"Title":"Ведомственный акт"},
{"ID":1,"Title":"Проект постановления Правительства Российской Федерации"},
{"ID":23,"Title":"Постановление Правительства Российской Федерации"},
{"ID":11,"Title":"Проект решения Евразийской экономической комиссии"},
{"ID":3,"Title":"Проект Указа Президента Российской Федерации"},
{"ID":22,"Title":"Указ Президента Российской Федерации"},
{"ID":6,"Title":"Проект федерального закона"},
{"ID":21,"Title":"Федеральный закон"}
{"ID":25,"Title":"Проект федерального закона, принятого Государственной думой Федерального собрания Российской Федерации во втором чтении"},
{"ID":26,"Title":"Проект федерального конституционного закона, принятого Государственной думой Федерального собрания Российской Федерации во втором чтении"},
{"ID":20,"Title":"Проект плана проведения ОФВ"},
{"ID":29,"Title":"Публикация проекта перечня нормативных правовых актов, содержащих обязательные требования, подлежащие оценке применения"},
{"ID":28,"Title":"Публикация проекта плана проведения оценки применения"},
{"ID":27,"Title":"Распоряжение правительства РФ"},
```

* *Stages* и *Statuses* - возможные варианты приведены ниже. Фильтрация происходит по статусу проекта на сайте в момент запроса. Как и в случае с другими указанными фильтрами, эти фильтры можно не указывать в запросе и получить по умолчанию проекты документов находящиеся на любых (всех) стадиях.
```
'npaFilter.Stages[0].Title': 'Текст',
'npaFilter.Stages[0].ID': '20',
'npaFilter.Stages[1].Title': 'Оценка',
'npaFilter.Stages[1].ID': '30',
'npaFilter.Stages[2].Title': 'Завершение',
'npaFilter.Stages[2].ID': '40',
'npaFilter.Stages[3].Title': 'Принятие',
'npaFilter.Stages[3].ID': '50'

'npaFilter.Statuses[0].Title': 'Идет обсуждение',
'npaFilter.Statuses[0].ID': '20',
'npaFilter.Statuses[1].Title': 'Обсуждение завершено',
'npaFilter.Statuses[1].ID': '30',
'npaFilter.Statuses[2].Title': 'Разработка завершена',
'npaFilter.Statuses[2].ID': '50',
'npaFilter.Statuses[3].Title': 'Отказ от продолжения разработки',
'npaFilter.Statuses[3].ID': '100'
```



